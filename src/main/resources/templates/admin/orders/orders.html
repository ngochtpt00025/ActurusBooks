<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kalles Shop - Quản lý đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/css/index.css" />
    <style>
        .table-container {
            max-height: 85vh;
            overflow-y: auto;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-PENDING {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-CONFIRMED {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-PREPARING {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #c6c8ca;
        }

        .status-SHIPPING {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .status-DELIVERED {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-CANCELLED {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-RETURNED {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #c6c8ca;
        }

        .action-btn {
            border: none;
            background: none;
            padding: 4px 8px;
            margin: 0 2px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-btn:hover {
            background-color: #f8f9fa;
            transform: scale(1.1);
        }

        .btn-view {
            color: #007bff;
        }

        .btn-edit {
            color: #28a745;
        }

        .btn-delete {
            color: #dc3545;
        }

        .btn-success {
            color: #28a745;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            font-size: 0.9rem;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(39, 205, 228, 0.18);
        }

        .order-detail-row {
            background-color: #f8f9fa;
            font-size: 0.9rem;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .order-item {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div th:replace="~{fragments/navbar-admin :: navbar}"></div>

        <!-- Nội dung chính -->
        <div class="flex-grow-1 p-4" style="background-color: #f8f9fa; height: 100vh; overflow: hidden;">
            <h2 class="mb-4" style="font-weight: 600; color: #1a1a1a;">Quản lý đơn hàng</h2>

            <!-- Thông báo -->
            <div id="alertContainer"></div>

            <!-- Form tìm kiếm -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <form method="GET" action="/admin/orders" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="search" name="search" th:value="${search}"
                                placeholder="Mã đơn, tên, email, SĐT...">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Trạng thái đơn hàng</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">Tất cả trạng thái</option>
                                <option value="Chờ xác nhận" th:selected="${selectedStatus == 'Chờ xác nhận'}">Chờ xác
                                    nhận</option>
                                <option value="Đã xác nhận" th:selected="${selectedStatus == 'Đã xác nhận'}">Đã xác nhận
                                </option>
                                <option value="Đang chuẩn bị" th:selected="${selectedStatus == 'Đang chuẩn bị'}">Đang
                                    chuẩn bị</option>
                                <option value="Đang giao" th:selected="${selectedStatus == 'Đang giao'}">Đang giao
                                </option>
                                <option value="Đã giao" th:selected="${selectedStatus == 'Đã giao'}">Đã giao</option>
                                <option value="Đã hủy" th:selected="${selectedStatus == 'Đã hủy'}">Đã hủy</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="paymentStatus" class="form-label">Trạng thái thanh toán</label>
                            <select class="form-select" id="paymentStatus" name="paymentStatus">
                                <option value="">Tất cả trạng thái</option>
                                <option value="Chưa thanh toán"
                                    th:selected="${selectedPaymentStatus == 'Chưa thanh toán'}">Chưa thanh toán</option>
                                <option value="Đã thanh toán" th:selected="${selectedPaymentStatus == 'Đã thanh toán'}">
                                    Đã thanh toán</option>
                                <option value="Hoàn tiền" th:selected="${selectedPaymentStatus == 'Hoàn tiền'}">Hoàn
                                    tiền</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-search"></i> Tìm kiếm
                            </button>
                            <a href="/admin/orders" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i> Reset
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bảng đơn hàng -->
            <div class="table-container bg-white rounded shadow-sm">
                <!-- Thông tin kết quả tìm kiếm -->
                <div class="px-3 py-2 border-bottom bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <span class="text-muted" th:text="'Tìm thấy ' + ${#lists.size(orders)} + ' đơn hàng'">Tìm
                                thấy 0 đơn hàng</span>
                            <span th:if="${search != null and !#strings.isEmpty(search)}" class="ms-2">
                                <span class="badge bg-primary">Từ khóa: [[${search}]]</span>
                            </span>
                            <span th:if="${selectedStatus != null and !#strings.isEmpty(selectedStatus)}" class="ms-1">
                                <span class="badge bg-warning">Trạng thái: [[${selectedStatus}]]</span>
                            </span>
                            <span th:if="${selectedPaymentStatus != null and !#strings.isEmpty(selectedPaymentStatus)}"
                                class="ms-1">
                                <span class="badge bg-info">Thanh toán: [[${selectedPaymentStatus}]]</span>
                            </span>
                        </div>
                        <div class="col-auto"
                            th:if="${search != null or selectedStatus != null or selectedPaymentStatus != null}">
                            <a href="/admin/orders" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Xóa bộ lọc
                            </a>
                        </div>
                    </div>
                </div>

                <table class="table table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th scope="col" style="font-weight: 600;">Mã đơn</th>
                            <th scope="col" style="font-weight: 600;">Khách hàng</th>
                            <th scope="col" style="font-weight: 600;">Ngày đặt</th>
                            <th scope="col" style="font-weight: 600;">Tổng tiền</th>
                            <th scope="col" style="font-weight: 600;">Trạng thái</th>
                            <th scope="col" style="font-weight: 600;">Thanh toán</th>
                            <th scope="col" style="font-weight: 600; text-align: center;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${orders}" class="fade-in">
                            <td th:text="'#' + ${order.order_id}" style="font-weight: 500;"></td>
                            <td>
                                <div th:text="${order.user.full_name}" style="font-weight: 500;"></div>
                                <small class="text-muted" th:text="${order.user.email}"></small>
                            </td>
                            <td th:text="${#temporals.format(order.order_date, 'dd/MM/yyyy HH:mm')}"></td>
                            <td th:text="${#numbers.formatCurrency(order.total_amount)}"
                                style="font-weight: 500; color: #27cde4;"></td>
                            <td>
                                <span class="status-badge" th:classappend="'status-' + ${order.status}"
                                    th:text="${order.status}"></span>
                            </td>
                            <td>
                                <span class="badge"
                                    th:classappend="${order.payment_status == 'Đã thanh toán'} ? 'bg-success' : 
                                                    (${order.payment_status == 'Hoàn tiền'} ? 'bg-warning' : 'bg-secondary')"
                                    th:text="${order.payment_status}"></span>
                            </td>
                            <td style="text-align: center;">
                                <a class="action-btn btn-view" th:href="@{'/admin/orders/detail/' + ${order.order_id}}"
                                    title="Xem chi tiết">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <button class="action-btn btn-edit" th:data-order-id="${order.order_id}"
                                    th:data-status="${order.status}"
                                    onclick="editOrderStatus(this.dataset.orderId, this.dataset.status)"
                                    title="Cập nhật trạng thái">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <!-- Download Invoice button -->
                                <a class="action-btn btn-success"
                                    th:href="@{'/admin/orders/invoice/' + ${order.order_id}}" target="_blank"
                                    title="Tải hóa đơn">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Chi tiết đơn hàng -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng #<span id="modalOrderId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Thông tin khách hàng</h6>
                            <p><strong>Tên:</strong> <span id="modalCustomerName"></span></p>
                            <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                            <p><strong>Điện thoại:</strong> <span id="modalCustomerPhone"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Thông tin đơn hàng</h6>
                            <p><strong>Ngày đặt:</strong> <span id="modalOrderDate"></span></p>
                            <p><strong>Trạng thái:</strong> <span id="modalOrderStatus" class="status-badge"></span></p>
                            <p><strong>Tổng tiền:</strong> <span id="modalTotalAmount"></span></p>
                        </div>
                    </div>
                    <hr>
                    <h6>Địa chỉ giao hàng</h6>
                    <p id="modalShippingAddress"></p>
                    <hr>
                    <h6>Sản phẩm đã đặt</h6>
                    <div id="orderItemsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="editOrderStatusFromModal()">Cập nhật trạng
                        thái</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cập nhật trạng thái -->
    <div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật trạng thái đơn hàng #<span id="statusModalOrderId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="orderStatus" class="form-label">Trạng thái mới</label>
                        <select class="form-select" id="orderStatus">
                            <option th:each="status : ${orderStatuses}" th:value="${status.name()}"
                                th:text="${status.displayName}"></option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentOrderId = null;

        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;

            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function viewOrderDetails(orderId) {
            fetch(`/admin/orders/${orderId}`)
                .then(response => response.json())
                .then(order => {
                    document.getElementById('modalOrderId').textContent = order.order_id;
                    document.getElementById('modalCustomerName').textContent = order.user.full_name;
                    document.getElementById('modalCustomerEmail').textContent = order.user.email;
                    document.getElementById('modalCustomerPhone').textContent = order.phone || 'Không có';

                    const orderDate = new Date(order.order_date);
                    document.getElementById('modalOrderDate').textContent = orderDate.toLocaleDateString('vi-VN') + ' ' + orderDate.toLocaleTimeString('vi-VN');

                    const statusElement = document.getElementById('modalOrderStatus');
                    statusElement.textContent = order.status;
                    statusElement.className = `status-badge status-${order.status}`;

                    document.getElementById('modalTotalAmount').textContent = new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(order.total_amount);

                    document.getElementById('modalShippingAddress').textContent = order.address || 'Không có thông tin';

                    // Hiển thị sản phẩm
                    const itemsContainer = document.getElementById('orderItemsContainer');
                    itemsContainer.innerHTML = '';

                    if (order.orderItems && order.orderItems.length > 0) {
                        order.orderItems.forEach(item => {
                            const itemHtml = `
                                <div class="order-item d-flex align-items-center">
                                    <img src="${item.book.image_url || '/img/placeholder.png'}" alt="${item.book.title}" class="me-3">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${item.book.title}</h6>
                                        <small class="text-muted">Số lượng: ${item.quantity} x ${new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(item.price)}</small>
                                    </div>
                                    <div class="text-end">
                                        <strong>${new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(item.quantity * item.price)}</strong>
                                    </div>
                                </div>
                            `;
                            itemsContainer.innerHTML += itemHtml;
                        });
                    } else {
                        itemsContainer.innerHTML = '<p class="text-muted">Không có sản phẩm</p>';
                    }

                    currentOrderId = orderId;
                    new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
                })
                .catch(error => {
                    showAlert('Lỗi khi tải chi tiết đơn hàng', 'danger');
                    console.error('Error:', error);
                });
        }

        function editOrderStatus(orderId, currentStatus) {
            currentOrderId = orderId;
            document.getElementById('statusModalOrderId').textContent = orderId;
            document.getElementById('orderStatus').value = currentStatus;
            new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
        }

        function editOrderStatusFromModal() {
            if (currentOrderId) {
                editOrderStatus(currentOrderId, document.getElementById('modalOrderStatus').className.includes('status-') ?
                    document.getElementById('modalOrderStatus').className.split('status-')[1] : 'PENDING');
                bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
            }
        }

        function updateOrderStatus() {
            if (!currentOrderId) return;

            const newStatus = document.getElementById('orderStatus').value;

            fetch(`/admin/orders/${currentOrderId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `status=${newStatus}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Lỗi khi cập nhật trạng thái', 'danger');
                    console.error('Error:', error);
                });
        }

        function deleteOrder(orderId) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) {
                fetch(`/admin/orders/${orderId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert(data.message, 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showAlert(data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        showAlert('Lỗi khi xóa đơn hàng', 'danger');
                        console.error('Error:', error);
                    });
            }
        }
    </script>
</body>

</html>