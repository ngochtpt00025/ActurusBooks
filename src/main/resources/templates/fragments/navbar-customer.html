<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="navbar">
        <section class="navbar-top">
            <nav class="navbar navbar-expand-lg bg-white shadow-sm py-3">
                <div class="row w-100 align-items-center">
                    <div class="col-2 text-center">
                        <a class="navbar-brand fw-bold" th:href="@{/}">ActurusBooks</a>
                    </div>
                    <div class="col-5">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" th:href="@{/}">Trang chủ</a></li>
                            <li class="nav-item"><a class="nav-link" th:href="@{/product}">Sản phẩm</a></li>
                            <li class="nav-item"><a class="nav-link" th:href="@{/promotions}">Khuyến mãi</a></li>
                            <li class="nav-item"><a class="nav-link" th:href="@{/contact}">Liên hệ</a></li>
                            <!-- <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-primary" href="#" role="button"
                                    data-bs-toggle="dropdown">
                                    <i class="bi bi-gear"></i> Quản lý
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" th:href="@{/admin/login}">
                                            <i class="bi bi-shield-check"></i> Đăng nhập Admin
                                        </a></li>
                                    <li><a class="dropdown-item" th:href="@{/customer/login}">
                                            <i class="bi bi-person"></i> Đăng nhập Khách hàng
                                        </a></li>
                                </ul>
                            </li> -->
                        </ul>
                    </div>
                    <div class="col-5 d-flex justify-content-end">
                        <div class="nav-icons d-flex align-items-center">
                            <!-- Search Form -->
                            <form class="me-3" action="/search" method="get">
                                <div class="input-group">
                                    <input type="text" name="q" class="form-control form-control-sm"
                                        placeholder="Tìm kiếm sách..." style="width: 200px;">
                                    <button class="btn btn-outline-secondary btn-sm" type="submit">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </form>
                            <!-- Icons -->
                            <!-- Hiển thị cho user đã đăng nhập -->
                            <div th:if="${session.user != null}">

                                <a th:if="${session.user == null or session.user.role != 'admin'}"
                                    th:href="@{/wishlist}" class="position-relative me-3" title="Yêu thích">
                                    <i class="bi bi-heart"></i>
                                    <span
                                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info"
                                        id="wishlist-count" style="font-size: 0.7rem; display: none;">0</span>
                                </a>
                                <!-- Chỉ hiển thị giỏ hàng nếu không phải admin -->
                                <a th:if="${session.user == null or session.user.role != 'admin'}"
                                    th:href="@{/cart/view}" class="position-relative me-3" title="Giỏ hàng">
                                    <i class="bi bi-cart"></i>
                                    <span
                                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                                        style="font-size: 0.7rem; min-width: 1.2em; display: inline-block;">0</span>
                                </a>
                                <!-- Hiển thị link admin nếu là admin -->
                                <a th:if="${session.user != null and session.user.role == 'admin'}"
                                    th:href="@{/admin/dashboard}" class="position-relative me-3" title="Quản trị">
                                    <i class="bi bi-gear-fill text-primary"></i>
                                </a>
                                <div class="dropdown d-inline">
                                    <a class="btn btn-outline-primary btn-sm dropdown-toggle" href="#" role="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-person-circle"></i> <span
                                            th:text="${session.user.full_name}">User</span>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" th:href="@{/user/dashboard}"><i
                                                    class="bi bi-speedometer2"></i> Dashboard</a></li>
                                        <li><a class="dropdown-item" th:href="@{/user/profile}"><i
                                                    class="bi bi-person"></i> Hồ sơ</a></li>
                                        <li><a class="dropdown-item" th:href="@{/user/orders}"><i
                                                    class="bi bi-box-seam"></i> Đơn hàng</a></li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li><a class="dropdown-item text-danger" th:href="@{/logout}"><i
                                                    class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Hiển thị cho khách vãng lai -->
                            <div th:if="${session.user == null}">
                                <a th:href="@{/cart/view}" class="position-relative me-3" title="Giỏ hàng">
                                    <i class="bi bi-cart"></i>
                                    <span
                                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                                        style="font-size: 0.7rem; min-width: 1.2em; display: inline-block;">0</span>
                                </a>
                                <a th:href="@{/login}" class="btn btn-outline-primary btn-sm me-2">
                                    <i class="bi bi-box-arrow-in-right"></i> Đăng nhập
                                </a>
                                <a th:href="@{/register}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-person-plus"></i> Đăng ký
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </section>
    </div>

    <!-- JavaScript để cập nhật cart count -->
    <script>
        function updateCartCount() {
            console.log('=== updateCartCount called ===');
            fetch('/cart/count')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(count => {
                    console.log('Cart count received:', count, typeof count);
                    // Update tất cả cart badges
                    const badges = document.querySelectorAll('.cart-count');
                    console.log('Found cart badges:', badges.length);

                    badges.forEach((badge, index) => {
                        console.log(`Updating badge ${index}:`, badge);
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                        badge.style.visibility = 'visible';
                        console.log(`Badge ${index} updated to:`, badge.textContent);
                    });
                })
                .catch(error => {
                    console.error('Error updating cart count:', error);
                });
        }

        // Cập nhật count khi load trang
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, updating cart count...');
            updateCartCount();
        });

        // Cập nhật count mỗi 30 giây
        setInterval(updateCartCount, 30000);

        // Cập nhật count khi có thay đổi trong localStorage (cho session storage sync)
        window.addEventListener('storage', function (e) {
            if (e.key === 'cartUpdated') {
                updateCartCount();
            }
        });

        // Function để trigger update từ cart pages
        window.updateCartCount = updateCartCount;
    </script>
</body>

</html>